<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile - NuestrasRecetas.club</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#10b981',
            'primary-dark': '#059669',
            'dark-bg': '#0f172a',
            'dark-surface': '#1e293b',
            'dark-surface-light': '#334155',
            'dark-border': '#475569',
            'dark-text': '#f1f5f9',
            'dark-text-muted': '#94a3b8'
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'pulse-gentle': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            }
          }
        }
      }
    }
  </script>
  <style>
    * { scrollbar-width: thin; scrollbar-color: #475569 #1e293b; }
    *::-webkit-scrollbar { width: 6px; }
    *::-webkit-scrollbar-track { background: #1e293b; }
    *::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    *::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    body { 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #f1f5f9;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .glass-panel { 
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .btn { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 600;
      color: white;
      transition: all 0.2s ease;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
      min-height: 44px;
    }
    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }
    .btn:active { transform: translateY(0); }
    
    .btn-secondary {
      background: rgba(71, 85, 105, 0.3);
      border: 1px solid rgba(71, 85, 105, 0.5);
      color: #f1f5f9;
      min-height: 44px;
    }
    .btn-secondary:hover {
      background: rgba(71, 85, 105, 0.5);
      border-color: rgba(71, 85, 105, 0.7);
    }
    
    .loading { animation: pulse-gentle; }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .glass-panel {
        border-radius: 12px;
        margin: 0;
      }
      
      .btn {
        padding: 12px 16px;
        font-size: 14px;
        min-height: 44px;
      }
      
      /* Navigation improvements */
      nav .max-w-7xl {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      nav .space-x-4 {
        gap: 0.5rem;
      }
      
      nav a, nav button {
        padding: 0.5rem;
        font-size: 0.875rem;
      }
      
      /* Profile header mobile */
      .text-3xl { font-size: 1.5rem; }
      .text-2xl { font-size: 1.25rem; }
      
      /* Stats layout mobile */
      .flex.items-center.gap-8 {
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: space-around;
      }
      
      /* Recipe grid mobile */
      .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3 {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      /* Tab navigation mobile */
      .tab-btn {
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
        min-height: 44px;
      }
    }
    
    @media (max-width: 480px) {
      /* Very small screens */
      .w-24.h-24 {
        width: 4rem;
        height: 4rem;
      }
      
      .text-3xl { font-size: 1.25rem; }
      .text-2xl { font-size: 1.125rem; }
      
      /* Profile actions stack vertically */
      .flex.items-center.gap-4 {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }
      
      .btn {
        justify-content: center;
      }
      
      /* Stats in 2 columns on very small screens */
      .flex.items-center.gap-8 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        text-align: center;
      }
    }
    
    /* Touch targets */
    @media (pointer: coarse) {
      .btn {
        min-height: 44px;
        min-width: 44px;
        padding: 12px 20px;
      }
      
      .tab-btn {
        min-height: 44px;
        padding: 12px 16px;
      }
      
      .glass-panel {
        cursor: pointer;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Navigation -->
  <nav class="glass-panel sticky top-0 z-50 mb-4 md:mb-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-14 md:h-16">
        <div class="flex items-center">
          <a href="/dashboard" class="text-lg md:text-2xl font-bold text-primary">
            <i class="fas fa-utensils mr-1 md:mr-2"></i>
            <span class="hidden sm:inline">NuestrasRecetas</span>
            <span class="inline sm:hidden">NR</span>
          </a>
        </div>
        <div class="flex items-center space-x-2 md:space-x-4">
          <a href="/dashboard" class="text-dark-text-muted hover:text-primary transition-colors p-2 md:px-3 md:py-2">
            <i class="fas fa-home mr-0 md:mr-1"></i>
            <span class="hidden md:inline">Dashboard</span>
          </a>
          <a href="/community" class="text-dark-text-muted hover:text-primary transition-colors p-2 md:px-3 md:py-2">
            <i class="fas fa-users mr-0 md:mr-1"></i>
            <span class="hidden md:inline">Community</span>
          </a>
          <a href="/groups" class="text-dark-text-muted hover:text-primary transition-colors p-2 md:px-3 md:py-2">
            <i class="fas fa-layer-group mr-0 md:mr-1"></i>
            <span class="hidden md:inline">Groups</span>
          </a>
          <button onclick="logout()" class="text-dark-text-muted hover:text-red-400 transition-colors p-2 md:px-3 md:py-2">
            <i class="fas fa-sign-out-alt mr-0 md:mr-1"></i>
            <span class="hidden md:inline">Logout</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
    <div id="loading" class="flex justify-center items-center h-64">
      <div class="text-center">
        <div class="loading text-4xl text-primary mb-4">
          <i class="fas fa-spinner"></i>
        </div>
        <p class="text-dark-text-muted">Loading profile...</p>
      </div>
    </div>

    <div id="profile-content" class="hidden">
      <!-- Profile Header -->
      <div class="glass-panel p-4 md:p-8 mb-6 md:mb-8">
        <div class="flex flex-col items-center md:flex-row md:items-start gap-4 md:gap-6">
          <div class="flex-shrink-0">
            <div class="w-20 h-20 md:w-24 md:h-24 rounded-full bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center text-white text-xl md:text-2xl font-bold" id="profile-avatar">
              <i class="fas fa-user"></i>
            </div>
          </div>
          <div class="flex-1 min-w-0 text-center md:text-left">
            <div class="flex flex-col gap-4">
              <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white mb-2" id="profile-name">Loading...</h1>
                <p class="text-dark-text-muted mb-2" id="profile-username">@loading</p>
                <p class="text-white text-sm md:text-base" id="profile-bio">Loading bio...</p>
              </div>
              <div class="flex items-center justify-center md:justify-start gap-4" id="profile-actions">
                <button class="btn" id="follow-btn" onclick="toggleFollow()">
                  <i class="fas fa-user-plus mr-2"></i>Follow
                </button>
              </div>
            </div>
            <div class="flex items-center justify-center md:justify-start gap-4 md:gap-8 mt-6">
              <div class="text-center">
                <div class="text-xl md:text-2xl font-bold text-white" id="recipe-count">0</div>
                <div class="text-dark-text-muted text-sm md:text-base">Recipes</div>
              </div>
              <div class="text-center">
                <div class="text-xl md:text-2xl font-bold text-white" id="follower-count">0</div>
                <div class="text-dark-text-muted text-sm md:text-base">Followers</div>
              </div>
              <div class="text-center">
                <div class="text-xl md:text-2xl font-bold text-white" id="following-count">0</div>
                <div class="text-dark-text-muted text-sm md:text-base">Following</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Tabs -->
      <div class="glass-panel mb-6 md:mb-8">
        <div class="border-b border-dark-border">
          <nav class="flex space-x-4 md:space-x-8 px-4 md:px-6 overflow-x-auto">
            <button class="tab-btn active py-3 md:py-4 px-1 border-b-2 border-primary text-primary font-medium whitespace-nowrap" data-tab="recipes">
              <i class="fas fa-utensils mr-1 md:mr-2"></i>Recipes
            </button>
            <button class="tab-btn py-3 md:py-4 px-1 border-b-2 border-transparent text-dark-text-muted hover:text-white font-medium whitespace-nowrap" data-tab="groups">
              <i class="fas fa-layer-group mr-1 md:mr-2"></i>Groups
            </button>
          </nav>
        </div>
      </div>

      <!-- Recipes Tab -->
      <div id="recipes-tab" class="tab-content">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6" id="recipes-grid">
          <!-- Recipes will be loaded here -->
        </div>
      </div>

      <!-- Groups Tab -->
      <div id="groups-tab" class="tab-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6" id="groups-grid">
          <!-- Groups will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden">
      <div class="glass-panel p-8 text-center">
        <div class="text-6xl text-red-400 mb-4">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h2 class="text-2xl font-bold text-white mb-2">Profile Not Found</h2>
        <p class="text-dark-text-muted mb-6">The profile you're looking for doesn't exist or is private.</p>
        <a href="/dashboard" class="btn">
          <i class="fas fa-home mr-2"></i>Go to Dashboard
        </a>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let profileData = null;
    let isFollowing = false;

    // Get username from URL
    const username = window.location.pathname.split('/').pop();

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadProfile();
      setupTabs();
    });

    function checkAuth() {
      fetch('/api/auth/me')
        .then(response => response.json())
        .then(data => {
          if (data.user) {
            currentUser = data.user;
          }
        })
        .catch(error => console.error('Auth check failed:', error));
    }

    function loadProfile() {
      fetch(`/api/profile/${username}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Profile not found');
          }
          return response.json();
        })
        .then(data => {
          profileData = data;
          displayProfile(data);
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('profile-content').classList.remove('hidden');
        })
        .catch(error => {
          console.error('Failed to load profile:', error);
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('error-state').classList.remove('hidden');
        });
    }

    function displayProfile(data) {
      const profile = data.profile;
      
      // Update profile header
      document.getElementById('profile-name').textContent = profile.name;
      document.getElementById('profile-username').textContent = `@${profile.username}`;
      document.getElementById('profile-bio').textContent = profile.bio || 'No bio yet';
      document.getElementById('recipe-count').textContent = profile.recipe_count;
      document.getElementById('follower-count').textContent = profile.follower_count;
      document.getElementById('following-count').textContent = profile.following_count;

      // Update avatar
      const avatar = document.getElementById('profile-avatar');
      // Clear existing content
      avatar.innerHTML = '';
      
      if (profile.avatar_url) {
        const img = document.createElement('img');
        img.src = profile.avatar_url;
        img.alt = profile.name || 'Profile';
        img.className = 'w-full h-full rounded-full object-cover';
        avatar.appendChild(img);
      } else {
        const span = document.createElement('span');
        span.textContent = (profile.name || 'U').charAt(0).toUpperCase();
        avatar.appendChild(span);
      }

      // Show/hide follow button
      if (currentUser && currentUser.username !== profile.username) {
        document.getElementById('profile-actions').classList.remove('hidden');
        // Set follow status from API response
        isFollowing = profile.is_following || false;
        updateFollowButton();
      } else {
        document.getElementById('profile-actions').classList.add('hidden');
      }

      // Load recipes and groups
      loadRecipes(data.recipes);
      loadGroups(data.groups);
    }


    function updateFollowButton() {
      const btn = document.getElementById('follow-btn');
      if (isFollowing) {
        btn.innerHTML = '<i class="fas fa-user-check"></i>Following';
        btn.classList.remove('btn');
        btn.classList.add('btn-secondary');
      } else {
        btn.innerHTML = '<i class="fas fa-user-plus"></i>Follow';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn');
      }
    }

    async function toggleFollow() {
      if (!currentUser) {
        alert('Please log in to follow users');
        return;
      }

      const userId = profileData.profile.id;
      const endpoint = isFollowing ? 'unfollow' : 'follow';
      const btn = document.getElementById('follow-btn');
      const originalText = btn.innerHTML;
      
      // Show loading state
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Loading...';
      btn.disabled = true;
      
      try {
        const response = await fetch(`/api/users/${userId}/${endpoint}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.ok) {
          isFollowing = !isFollowing;
          updateFollowButton();
          
          // Update follower count
          const followerCount = document.getElementById('follower-count');
          const currentCount = parseInt(followerCount.textContent);
          followerCount.textContent = isFollowing ? currentCount + 1 : currentCount - 1;
          
          // Show success message
          if (data.message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg z-50 animate-slide-up';
            toast.textContent = data.message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
          }
        } else {
          alert(data.error || 'Failed to update follow status');
          btn.innerHTML = originalText;
        }
      } catch (error) {
        console.error('Follow toggle failed:', error);
        alert('Failed to update follow status');
        btn.innerHTML = originalText;
      } finally {
        btn.disabled = false;
      }
    }

    function loadRecipes(recipes) {
      const grid = document.getElementById('recipes-grid');
      grid.innerHTML = '';

      if (recipes.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="text-6xl text-dark-text-muted mb-4">
              <i class="fas fa-utensils"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">No recipes yet</h3>
            <p class="text-dark-text-muted">This user hasn't shared any recipes yet.</p>
          </div>
        `;
        return;
      }

      recipes.forEach(recipe => {
        const card = createRecipeCard(recipe);
        grid.appendChild(card);
      });
    }

    function createRecipeCard(recipe) {
      const card = document.createElement('div');
      card.className = 'glass-panel p-4 md:p-6 hover:transform hover:scale-105 transition-all duration-200 cursor-pointer';
      card.onclick = () => window.location.href = `/dashboard#recipe-${recipe.id}`;

      card.innerHTML = `
        <div class="aspect-video bg-gradient-to-br from-primary/20 to-primary-dark/20 rounded-lg mb-3 md:mb-4 flex items-center justify-center">
          ${recipe.image_url ? 
            `<img src="${recipe.image_url}" alt="${recipe.title}" class="w-full h-full object-cover rounded-lg">` :
            `<i class="fas fa-utensils text-2xl md:text-4xl text-primary"></i>`
          }
        </div>
        <h3 class="text-base md:text-lg font-semibold text-white mb-2 line-clamp-2">${recipe.title}</h3>
        <p class="text-dark-text-muted text-xs md:text-sm mb-3 md:mb-4 line-clamp-2">${recipe.description || 'No description'}</p>
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 md:gap-0 text-xs md:text-sm text-dark-text-muted">
          <div class="flex items-center gap-3 md:gap-4">
            <span><i class="fas fa-clock mr-1"></i>${recipe.prep_time + recipe.cook_time}min</span>
            <span><i class="fas fa-users mr-1"></i>${recipe.servings}</span>
          </div>
          <div class="flex items-center gap-2">
            <span><i class="fas fa-heart mr-1"></i>${recipe.like_count || 0}</span>
            <span><i class="fas fa-comment mr-1"></i>${recipe.comment_count || 0}</span>
          </div>
        </div>
      `;

      return card;
    }

    function loadGroups(groups) {
      const grid = document.getElementById('groups-grid');
      grid.innerHTML = '';

      if (groups.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="text-6xl text-dark-text-muted mb-4">
              <i class="fas fa-layer-group"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">No groups yet</h3>
            <p class="text-dark-text-muted">This user hasn't created any groups yet.</p>
          </div>
        `;
        return;
      }

      groups.forEach(group => {
        const card = createGroupCard(group);
        grid.appendChild(card);
      });
    }

    function createGroupCard(group) {
      const card = document.createElement('div');
      card.className = 'glass-panel p-4 md:p-6 hover:transform hover:scale-105 transition-all duration-200 cursor-pointer';
      card.onclick = () => window.location.href = `/group/${group.id}`;

      card.innerHTML = `
        <div class="aspect-video bg-gradient-to-br from-primary/20 to-primary-dark/20 rounded-lg mb-3 md:mb-4 flex items-center justify-center">
          ${group.avatar_url ? 
            `<img src="${group.avatar_url}" alt="${group.name}" class="w-full h-full object-cover rounded-lg">` :
            `<i class="fas fa-layer-group text-2xl md:text-4xl text-primary"></i>`
          }
        </div>
        <h3 class="text-base md:text-lg font-semibold text-white mb-2">${group.name}</h3>
        <p class="text-dark-text-muted text-xs md:text-sm mb-3 md:mb-4 line-clamp-2">${group.description || 'No description'}</p>
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 text-xs md:text-sm text-dark-text-muted">
          <div class="flex items-center gap-3 md:gap-4">
            <span><i class="fas fa-users mr-1"></i>${group.member_count} members</span>
            <span><i class="fas fa-comment mr-1"></i>${group.post_count} posts</span>
          </div>
          <span class="px-2 py-1 rounded-full text-xs self-start md:self-auto ${group.is_public ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">
            ${group.is_public ? 'Public' : 'Private'}
          </span>
        </div>
      `;

      return card;
    }

    function setupTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.dataset.tab;
          
          // Update button states
          tabBtns.forEach(b => {
            b.classList.remove('active', 'border-primary', 'text-primary');
            b.classList.add('border-transparent', 'text-dark-text-muted');
          });
          btn.classList.add('active', 'border-primary', 'text-primary');
          btn.classList.remove('border-transparent', 'text-dark-text-muted');

          // Update content visibility
          tabContents.forEach(content => {
            content.classList.add('hidden');
          });
          document.getElementById(`${targetTab}-tab`).classList.remove('hidden');
        });
      });
    }

    function logout() {
      fetch('/api/auth/logout', { method: 'POST' })
        .then(() => {
          window.location.href = '/';
        })
        .catch(error => {
          console.error('Logout failed:', error);
          window.location.href = '/';
        });
    }
  </script>
</body>
</html> 